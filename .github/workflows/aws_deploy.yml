name: CD

# 지정한 branch ([main])에서 command(pull)가 수행되면 이 workflow가 동작
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

  # trigger 없어도 수동으로 동작
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: checkout release
      uses: actions/checkout@v3

    - name: Set up Jdk 17
      uses: actions/setup-java@v1
      with:
        java-version: 17

    - name: application yml
      uses: actions/checktout@v3
    - run: touch ./src/main/resources/application.yml
    - run: echo "${{secrets.APPLICATIONS}}" > ./src/main/resources/application.yml
    - uses: actions/upload-artifact@v3
      with:
        name: application.yml
        path: ./src/main/resources/application.yml

    - name: Grant excute permission for gradlew
      run: chmod +x ./gradlew
      shell: bash

    - name: Build Gradle
      run: ./gradlew build -Dspring.profiles.include=server
      shell: bash

    # - name: Test Gradle
    #   run: ./gradlew test
    #   shell: bash

    # - name: Make zip file
    #   run: zip -qq -r ./$GITHUB_SHA.zip
    #   shell: bash

    # - name: AWS configure credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.ACCESS_KEY }}
    #     aws-secret-key-id: ${{ secrets.SECRET_KEY }}
    #     aws-region: ${{ secrets.REGION }}

    # - name: Upload to S3
    #   run: aws s3 --region ap-northeast-2 ./$GITHUB_SHA.zip s3://$S3_BUCKET_NAME/spring_boot_project/$GITHUB_SHA.zip

    # - name: Code Deploy
    #   run: aws deploy create-deployment --code_deploy chabak-map-deploy --deployment-config-name CodeDeployDefault.AllAtOnce --github_active_group
